# Deploy workflow - Deploy install script to get.pongogo.com
name: Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version being deployed (e.g., v0.1.0)'
        required: true
        type: string
  release:
    types: [published]

env:
  AZURE_STORAGE_ACCOUNT: pongogodownloads
  AZURE_RESOURCE_GROUP: pongogo-rg

jobs:
  deploy-install-script:
    name: Deploy Install Script
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' && !github.event.release.prerelease)

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          # Remove 'v' prefix if present for pip install
          VERSION_CLEAN="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_clean=${VERSION_CLEAN}" >> $GITHUB_OUTPUT

      - name: Prepare install script
        run: |
          mkdir -p deploy

          # Create index.html that serves the script
          cat > deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>ü¶ß Pongogo Installer</title>
            <meta http-equiv="refresh" content="0; url=install.sh">
          </head>
          <body>
            <p>Redirecting to <a href="install.sh">install.sh</a>...</p>
          </body>
          </html>
          EOF

          # Create install script with Docker requirement
          cat > deploy/install.sh << 'SCRIPT'
          #!/bin/bash
          # Pongogo Installer
          # Usage: curl -sSL https://get.pongogo.com | bash

          PONGOGO_VERSION="__VERSION__"

          set -e

          # Colors (only if terminal supports it)
          # Aligned with Pongogo style guide: canopy (success), durian (warning),
          # racer (error), mist (info), orang (brand). Using bold variants for
          # legibility on both light and dark terminal backgrounds.
          if [ -t 1 ]; then
              GREEN='\033[1;32m'   # canopy - success
              YELLOW='\033[1;33m'  # durian - warning
              RED='\033[1;31m'     # racer - error
              CYAN='\033[1;36m'    # mist - info
              ORANGE='\033[38;5;208m'  # orang - brand (256-color)
              BOLD='\033[1m'
              NC='\033[0m'
          else
              GREEN='' YELLOW='' RED='' CYAN='' ORANGE='' BOLD='' NC=''
          fi

          info() { echo -e "${GREEN}‚úì${NC} $1"; }
          warn() { echo -e "${YELLOW}‚ö†${NC} $1"; }
          error() { echo -e "${RED}‚úó${NC} $1"; exit 1; }

          # Detect OS
          IS_WSL=false
          IS_MACOS=false
          IS_LINUX=false

          if [[ "$OSTYPE" == "darwin"* ]]; then
              IS_MACOS=true
          elif grep -qiE "(microsoft|wsl)" /proc/version 2>/dev/null; then
              IS_WSL=true
          else
              IS_LINUX=true
          fi

          # ASCII art header (brand orange)
          printf '\n'
          printf "${ORANGE}"
          printf '     ___  ____  _  ___________  _________\n'
          printf '    / _ \\/ __ \\/ |/ / ___/ __ \\/ ___/ __ \\\n'
          printf '   / ___/ /_/ /    / (_ / /_/ / (_ / /_/ /\n'
          printf '  /_/   \\____/_/|_/\\___/\\____/\\___/\\____/\n'
          printf "${NC}\n"
          echo -e "  $PONGOGO_VERSION               ${BOLD}~ Go, Pon-go-go! ~${NC}"
          if $IS_WSL; then
              echo -e "  ${CYAN}(WSL detected)${NC}"
          fi
          printf '\n'

          # Check Docker
          if ! command -v docker &> /dev/null; then
              echo -e "${RED}‚úó${NC} Docker is required but not installed."
              echo ""
              if $IS_WSL; then
                  echo "WSL requires Docker Desktop for Windows with WSL integration:"
                  echo ""
                  echo "  1. Install Docker Desktop: https://docs.docker.com/desktop/install/windows-install/"
                  echo "  2. Open Docker Desktop Settings ‚Üí Resources ‚Üí WSL Integration"
                  echo "  3. Enable integration for your WSL distro"
                  echo "  4. Restart your WSL terminal"
              else
                  echo "Install Docker:"
                  echo "  macOS:   brew install --cask docker"
                  echo "  Linux:   https://docs.docker.com/engine/install/"
              fi
              exit 1
          fi

          if ! docker info &> /dev/null 2>&1; then
              echo -e "${YELLOW}‚ö†${NC} Docker is installed but not running."
              if $IS_WSL; then
                  echo ""
                  echo "Start Docker Desktop from Windows, then re-run this installer."
                  echo ""
                  echo "If Docker Desktop is running but docker commands fail:"
                  echo "  1. Open Docker Desktop Settings ‚Üí Resources ‚Üí WSL Integration"
                  echo "  2. Ensure your WSL distro is enabled"
                  echo "  3. Restart your WSL terminal: wsl --shutdown (from PowerShell)"
                  exit 1
              fi
              read -p $'Would you like to start Docker? \033[94m[Y/n]:\033[0m ' -r < /dev/tty
              echo ""
              if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                  echo "Starting Docker..."
                  if $IS_MACOS; then
                      open -a Docker
                  elif command -v systemctl &> /dev/null; then
                      # Try rootless docker first, then system docker
                      if systemctl --user start docker 2>/dev/null; then
                          echo "Started rootless Docker"
                      elif sudo systemctl start docker 2>/dev/null; then
                          echo "Started system Docker"
                      else
                          echo ""
                          echo -e "${RED}Failed to start Docker.${NC}"
                          echo ""
                          echo "Try: sudo systemctl start docker"
                          echo ""
                          echo "If Docker requires sudo, add yourself to the docker group:"
                          echo "  sudo usermod -aG docker \$USER"
                          echo "  (then log out and back in)"
                          echo ""
                          error "Please start Docker manually and re-run the installer."
                          exit 1
                      fi
                  else
                      error "Unable to start Docker automatically. Please start it manually."
                      exit 1
                  fi
                  # Wait for Docker to be ready (try with and without sudo)
                  echo "Waiting for Docker to start..."
                  for i in {1..30}; do
                      if docker info &> /dev/null 2>&1 || sudo docker info &> /dev/null 2>&1; then
                          info "Docker is now running"
                          break
                      fi
                      sleep 2
                  done
                  # Verify Docker is accessible
                  if ! docker info &> /dev/null 2>&1 && ! sudo docker info &> /dev/null 2>&1; then
                      error "Docker failed to start. Please start it manually and re-run the installer."
                      exit 1
                  fi
              else
                  error "Docker must be running to continue."
                  exit 1
              fi
          fi

          # Check if docker works without sudo
          if ! docker info &> /dev/null 2>&1; then
              if sudo docker info &> /dev/null 2>&1; then
                  echo ""
                  echo -e "${YELLOW}‚ö†${NC} Docker requires sudo (you're not in the docker group)."
                  echo ""
                  echo "To fix this, run:"
                  echo "  sudo usermod -aG docker \$USER"
                  echo ""
                  echo "Then log out and back in (required for group changes to take effect)."
                  echo ""
                  echo "After logging back in, re-run this installer."
                  exit 1
              else
                  error "Docker is not accessible."
                  exit 1
              fi
          fi

          info "Docker is available"

          # Pull the image
          info "Pulling Pongogo Docker image..."
          docker pull pongogo.azurecr.io/pongogo:stable

          # Install pongogo CLI wrapper
          PONGOGO_BIN="$HOME/.local/bin"
          mkdir -p "$PONGOGO_BIN"
          cat > "$PONGOGO_BIN/pongogo" << 'PONGOGO_CLI'
          #!/bin/bash
          # Pongogo CLI wrapper - runs commands in Docker container
          # Special commands (uninstall, help) run on host

          case "$1" in
            uninstall)
              echo "ü¶ß Pongogo Uninstaller"
              echo "====================="
              echo ""

              # Skip confirmation if --force flag is passed
              FORCE=false
              for arg in "$@"; do
                if [[ "$arg" == "--force" || "$arg" == "-f" ]]; then
                  FORCE=true
                fi
              done

              if ! $FORCE; then
                echo "This will remove the Pongogo CLI wrapper and MCP configuration."
                echo ""
                read -p $'Continue with uninstall? \033[94m[y/N]:\033[0m ' -r < /dev/tty
                echo ""
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                  echo "Uninstall cancelled."
                  exit 0
                fi
              fi

              # Remove CLI wrapper
              if [ -f "$HOME/.local/bin/pongogo" ]; then
                rm "$HOME/.local/bin/pongogo"
                echo "‚úì Removed ~/.local/bin/pongogo"
              fi

              # Remove MCP config from project-local .mcp.json (primary location)
              if [ -f ".mcp.json" ] && command -v python3 &> /dev/null; then
                python3 -c "
          import json, sys
          p = '.mcp.json'
          try:
              c = json.load(open(p))
              if 'mcpServers' in c and 'pongogo-knowledge' in c['mcpServers']:
                  del c['mcpServers']['pongogo-knowledge']
                  # Remove file if mcpServers is now empty
                  if not c['mcpServers']:
                      import os
                      os.remove(p)
                      print('‚úì Removed .mcp.json (no other MCP servers configured)')
                  else:
                      json.dump(c, open(p, 'w'), indent=2)
                      print('‚úì Removed pongogo-knowledge from .mcp.json')
              else:
                  print('‚úì No pongogo-knowledge config found in .mcp.json')
          except FileNotFoundError:
              pass
          except Exception as e:
              print(f'‚ö† Could not modify .mcp.json: {e}')
          "
              elif [ -f ".mcp.json" ]; then
                echo "‚ö† Found .mcp.json but Python 3 not available"
                echo "  Manually remove 'pongogo-knowledge' from mcpServers in .mcp.json"
              else
                echo "‚úì No .mcp.json found in current directory"
              fi

              # Remove MCP config from .claude/mcp.json (Claude Code project location)
              if [ -f ".claude/mcp.json" ] && command -v python3 &> /dev/null; then
                python3 -c "
          import json, sys, os
          p = '.claude/mcp.json'
          try:
              c = json.load(open(p))
              if 'mcpServers' in c and 'pongogo-knowledge' in c['mcpServers']:
                  del c['mcpServers']['pongogo-knowledge']
                  if not c['mcpServers']:
                      os.remove(p)
                      # Remove .claude dir if empty
                      if os.path.isdir('.claude') and not os.listdir('.claude'):
                          os.rmdir('.claude')
                          print('‚úì Removed .claude/mcp.json and empty .claude/ directory')
                      else:
                          print('‚úì Removed .claude/mcp.json (no other MCP servers configured)')
                  else:
                      json.dump(c, open(p, 'w'), indent=2)
                      print('‚úì Removed pongogo-knowledge from .claude/mcp.json')
              else:
                  print('‚úì No pongogo-knowledge config found in .claude/mcp.json')
          except FileNotFoundError:
              pass
          except Exception as e:
              print(f'‚ö† Could not modify .claude/mcp.json: {e}')
          "
              elif [ -f ".claude/mcp.json" ]; then
                echo "‚ö† Found .claude/mcp.json but Python 3 not available"
                echo "  Manually remove 'pongogo-knowledge' from mcpServers in .claude/mcp.json"
              fi

              # Remove UserPromptSubmit hook from .claude/settings.local.json
              if [ -f ".claude/settings.local.json" ] && command -v python3 &> /dev/null; then
                python3 -c "
          import json, sys, os
          p = '.claude/settings.local.json'
          try:
              c = json.load(open(p))
              modified = False
              if 'hooks' in c and 'UserPromptSubmit' in c['hooks']:
                  # Remove pongogo-route hooks
                  new_hooks = []
                  for hook_group in c['hooks']['UserPromptSubmit']:
                      if 'hooks' in hook_group:
                          hook_group['hooks'] = [h for h in hook_group['hooks']
                                                  if 'pongogo-route' not in h.get('command', '')]
                          if hook_group['hooks']:
                              new_hooks.append(hook_group)
                      else:
                          new_hooks.append(hook_group)
                  if new_hooks:
                      c['hooks']['UserPromptSubmit'] = new_hooks
                  else:
                      del c['hooks']['UserPromptSubmit']
                  if not c['hooks']:
                      del c['hooks']
                  modified = True
              if modified:
                  if not c:
                      os.remove(p)
                      print('‚úì Removed .claude/settings.local.json (no other settings)')
                  else:
                      json.dump(c, open(p, 'w'), indent=2)
                      print('‚úì Removed pongogo hooks from .claude/settings.local.json')
              else:
                  print('‚úì No pongogo hooks found in .claude/settings.local.json')
          except FileNotFoundError:
              pass
          except Exception as e:
              print(f'‚ö† Could not modify .claude/settings.local.json: {e}')
          "
              elif [ -f ".claude/settings.local.json" ]; then
                echo "‚ö† Found .claude/settings.local.json but Python 3 not available"
                echo "  Manually remove pongogo hooks from .claude/settings.local.json"
              fi

              # Also check global ~/.claude.json (legacy location)
              CLAUDE_CONFIG="$HOME/.claude.json"
              if [ -f "$CLAUDE_CONFIG" ] && command -v python3 &> /dev/null; then
                python3 -c "
          import json, sys
          p = sys.argv[1]
          try:
              c = json.load(open(p))
              if 'mcpServers' in c and 'pongogo-knowledge' in c['mcpServers']:
                  del c['mcpServers']['pongogo-knowledge']
                  json.dump(c, open(p, 'w'), indent=2)
                  print('‚úì Removed pongogo-knowledge from ~/.claude.json')
              else:
                  print('‚úì No pongogo-knowledge config found in ~/.claude.json')
          except Exception as e:
              print(f'‚ö† Could not modify ~/.claude.json: {e}')
          " "$CLAUDE_CONFIG"
              fi

              # Offer to remove .pongogo directory
              if [ -d ".pongogo" ]; then
                echo ""
                read -p $'Remove .pongogo/ directory (config and instructions)? \033[94m[y/N]:\033[0m ' -r
                echo ""
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                  rm -rf .pongogo
                  echo "‚úì Removed .pongogo/"
                fi
              fi

              # Offer to remove slash commands
              if ls .claude/commands/pongogo-*.md &> /dev/null 2>&1; then
                echo ""
                read -p $'Remove Pongogo slash commands from .claude/commands/? \033[94m[y/N]:\033[0m ' -r
                echo ""
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                  rm -f .claude/commands/pongogo-*.md
                  echo "‚úì Removed Pongogo slash commands"
                fi
              fi

              # Offer to remove Docker image
              if docker image inspect pongogo.azurecr.io/pongogo:stable &> /dev/null 2>&1; then
                echo ""
                read -p $'Remove Docker image? \033[94m[y/N]:\033[0m ' -r
                echo ""
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                  docker rmi pongogo.azurecr.io/pongogo:stable
                  echo "‚úì Removed Docker image"
                fi
              fi

              echo ""
              echo "Pongogo uninstalled. Restart any running Claude Code sessions to complete removal."
              ;;

            upgrade)
              echo "ü¶ß Upgrading Pongogo..."
              echo ""

              # Pull latest stable image
              if docker pull pongogo.azurecr.io/pongogo:stable; then
                echo ""
                echo "‚úÖ Upgrade complete!"
                echo ""
                echo "To use the new version:"
                echo "  1. Exit Claude Code (or restart the terminal)"
                echo "  2. Re-enter Claude Code"
                echo "  3. Run /mcp to verify Pongogo is connected"
              else
                echo ""
                echo "‚ùå Upgrade failed. Check your Docker installation and network connection."
                exit 1
              fi
              ;;

            --help|-h|help)
              echo "ü¶ß Pongogo - AI agent knowledge routing"
              echo ""
              echo "Usage: pongogo <command> [options]"
              echo ""
              echo "Commands:"
              echo "  init          Initialize Pongogo in current directory"
              echo "  setup-mcp     Configure Claude Code MCP server"
              echo "  upgrade       Update to latest version"
              echo "  uninstall     Remove Pongogo from this machine"
              echo "  --help        Show this help message"
              echo ""
              echo "Examples:"
              echo "  pongogo init              # Initialize in current repo"
              echo "  pongogo init --minimal    # Minimal installation"
              echo "  pongogo init --force      # Overwrite existing installation"
              echo "  pongogo upgrade           # Update to latest version"
              echo "  pongogo uninstall         # Remove Pongogo (interactive)"
              echo "  pongogo uninstall --force # Remove Pongogo (no confirmation)"
              ;;

            init)
              # Check for updates before init (unless we just installed)
              if [ -z "$PONGOGO_FROM_INSTALLER" ]; then
                # Compare local and remote image digests
                LOCAL_DIGEST=$(docker inspect pongogo.azurecr.io/pongogo:stable --format='{{index .RepoDigests 0}}' 2>/dev/null | cut -d'@' -f2)
                REMOTE_DIGEST=$(docker manifest inspect pongogo.azurecr.io/pongogo:stable 2>/dev/null | grep -m1 '"digest"' | cut -d'"' -f4)

                if [ -n "$REMOTE_DIGEST" ] && [ -n "$LOCAL_DIGEST" ] && [ "$LOCAL_DIGEST" != "$REMOTE_DIGEST" ]; then
                  echo "ü¶ß A newer version of Pongogo is available."
                  echo ""
                  read -p $'Update before initializing? \033[94m[Y/n]:\033[0m ' -r < /dev/tty
                  echo ""
                  if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                    echo "Pulling latest version..."
                    docker pull pongogo.azurecr.io/pongogo:stable
                    echo ""
                  fi
                fi
              fi

              # Run init in Docker container
              ENV_ARGS="-e HOST_PROJECT_DIR=$(pwd)"
              if [ -n "$PONGOGO_FROM_INSTALLER" ]; then
                ENV_ARGS="$ENV_ARGS -e PONGOGO_FROM_INSTALLER=1"
              fi
              if [ -t 1 ] && [ -e /dev/tty ]; then
                docker run -it --rm --user "$(id -u):$(id -g)" -v "$(pwd)":/project:z -w /project $ENV_ARGS --entrypoint pongogo pongogo.azurecr.io/pongogo:stable "$@" < /dev/tty
              else
                docker run --rm --user "$(id -u):$(id -g)" -v "$(pwd)":/project:z -w /project $ENV_ARGS --entrypoint pongogo pongogo.azurecr.io/pongogo:stable "$@"
              fi
              ;;

            *)
              # All other commands run in Docker container
              # Use --user to match host user so created files have correct ownership
              # Use :z suffix for SELinux compatibility (Fedora, RHEL, CentOS)
              # Pass HOST_PROJECT_DIR so init can create correct MCP config paths
              # Pass PONGOGO_FROM_INSTALLER if set (skips version check during install)
              # Redirect from /dev/tty for interactive input (works with curl|bash)
              ENV_ARGS="-e HOST_PROJECT_DIR=$(pwd)"
              if [ -n "$PONGOGO_FROM_INSTALLER" ]; then
                ENV_ARGS="$ENV_ARGS -e PONGOGO_FROM_INSTALLER=1"
              fi
              if [ -t 1 ] && [ -e /dev/tty ]; then
                docker run -it --rm --user "$(id -u):$(id -g)" -v "$(pwd)":/project:z -w /project $ENV_ARGS --entrypoint pongogo pongogo.azurecr.io/pongogo:stable "$@" < /dev/tty
              else
                docker run --rm --user "$(id -u):$(id -g)" -v "$(pwd)":/project:z -w /project $ENV_ARGS --entrypoint pongogo pongogo.azurecr.io/pongogo:stable "$@"
              fi
              ;;
          esac
          PONGOGO_CLI
          chmod +x "$PONGOGO_BIN/pongogo"

          # Add to PATH if not already there
          if [[ ":$PATH:" != *":$PONGOGO_BIN:"* ]]; then
              warn "Add ~/.local/bin to your PATH to use 'pongogo' command"
              echo "  Add this to your shell config: export PATH=\"\$HOME/.local/bin:\$PATH\""
          fi

          info "Pongogo installed successfully!"
          echo ""

          # Check if in a git repo and offer to init
          if git rev-parse --git-dir > /dev/null 2>&1; then
              echo "You're in a git repository: $(basename "$(pwd)")"
              if [ -d ".pongogo" ]; then
                  # Already initialized - this is an upgrade, don't prompt
                  info "Pongogo is already initialized in this repo."
                  echo "  To reinitialize: pongogo init --force"
              else
                  read -p $'Would you like to initialize Pongogo here? \033[94m[Y/n]:\033[0m ' -r < /dev/tty
                  echo ""
                  if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
                      info "Initializing Pongogo..."
                      PONGOGO_FROM_INSTALLER=1 "$PONGOGO_BIN/pongogo" init
                  else
                      echo ""
                      echo "Run 'pongogo init' when you're ready."
                  fi
              fi
          else
              echo "Navigate to your project and run:"
              echo "  pongogo init"
          fi
          SCRIPT

          # Embed version into install script
          sed -i 's/__VERSION__/${{ steps.version.outputs.version }}/g' deploy/install.sh

          chmod +x deploy/install.sh

          # Verify script is valid bash
          bash -n deploy/install.sh

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Storage
        run: |
          # Upload to $web container (static website)
          az storage blob upload-batch \
            --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --destination '$web' \
            --source deploy \
            --overwrite \
            --auth-mode login \
            --content-type "text/html" \
            --pattern "*.html"

          az storage blob upload-batch \
            --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --destination '$web' \
            --source deploy \
            --overwrite \
            --auth-mode login \
            --content-type "text/x-shellscript" \
            --pattern "*.sh"

          echo "Deployed to https://get.pongogo.com"

      - name: Purge CDN cache
        run: |
          az afd endpoint purge \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --profile-name pongogo-cdn \
            --endpoint-name pongogo-downloads \
            --content-paths "/*" \
            --no-wait || true
